From cd5cbdbe7bc1a7dacc47ed3d7a8507ffdc17f4ff Mon Sep 17 00:00:00 2001
From: DeJay <contact@dejaydev.com>
Date: Wed, 4 Dec 2019 08:55:04 -0600
Subject: [PATCH 16/24] [update] switch to b1nzys disco, some other stuff.

---
 data/actions_simple.yaml       |  4 ++++
 frontend/serve.js              |  2 +-
 requirements.txt               |  2 +-
 rowboat/constants.py           |  6 +++---
 rowboat/plugins/admin.py       | 10 ++++++----
 rowboat/plugins/modlog/core.py |  2 +-
 rowboat/plugins/spam.py        |  9 +++------
 rowboat/plugins/utilities.py   | 12 +++++++-----
 8 files changed, 26 insertions(+), 21 deletions(-)

diff --git a/data/actions_simple.yaml b/data/actions_simple.yaml
index 22dd344..706fc9f 100644
--- a/data/actions_simple.yaml
+++ b/data/actions_simple.yaml
@@ -90,6 +90,10 @@ COMMAND_USED:
   emoji: wrench
   format: "{e.author!s} (`{e.author.id}`) used command in **{e.channel}** `{e.content!s}`"
 
+SPAM:
+  emoji: helmet_with_cross
+  format: "{v.member!s} (`{v.member.id}`) violated {v.label} ({v.event.channel.mention}): {v.msg}"
+
 SPAM_DEBUG:
   emoji: helmet_with_cross
   format: "{v.member!s} (`{v.member.id}`) violated {v.label} ({v.event.channel.mention}): {v.msg}"
diff --git a/frontend/serve.js b/frontend/serve.js
index 8e6e2d0..f312139 100644
--- a/frontend/serve.js
+++ b/frontend/serve.js
@@ -10,7 +10,7 @@ const app = express();
 
 let proxyURL = 'http://localhost:8686';
 
-if (process.env.NODE_ENV == 'production') {
+if (process.env.NODE_ENV == 'docker') {
 	proxyURL = 'http://web:8686';
 }
 
diff --git a/requirements.txt b/requirements.txt
index 3a5f4e6..56eafd8 100644
--- a/requirements.txt
+++ b/requirements.txt
@@ -6,7 +6,7 @@ click==7.0
 contextlib2==0.6.0.post1
 cssselect==1.1.0
 dill==0.3.1.1
--e git+https://github.com/elderlabs/disco.git@8c19162f2f3498fd4d82af0c89d0869751edffa0#egg=disco-py
+-e git+https://github.com/b1naryth1ef/disco.git#egg=disco-py
 # disco-py==0.0.11-rc.8
 Distance==0.1.3
 emoji==0.5.4
diff --git a/rowboat/constants.py b/rowboat/constants.py
index 785e667..f12d8b1 100644
--- a/rowboat/constants.py
+++ b/rowboat/constants.py
@@ -24,9 +24,9 @@ EMOJI_RE = re.compile(r'<:(.+):([0-9]+)>')
 USER_MENTION_RE = re.compile('<@!?([0-9]+)>')
 
 # IDs and such
-ROWBOAT_GUILD_ID = 343046181771018242
-ROWBOAT_USER_ROLE_ID = 351789665386364929
-ROWBOAT_CONTROL_CHANNEL = 351794308254269441
+ROWBOAT_GUILD_ID = 342506939340685312
+ROWBOAT_USER_ROLE_ID = 648955559541997578
+ROWBOAT_CONTROL_CHANNEL = 598682202464845845
 
 # Discord Error codes
 ERR_UNKNOWN_MESSAGE = 10008
diff --git a/rowboat/plugins/admin.py b/rowboat/plugins/admin.py
index bf8c93f..f91fb33 100644
--- a/rowboat/plugins/admin.py
+++ b/rowboat/plugins/admin.py
@@ -952,12 +952,14 @@ class AdminPlugin(Plugin):
         self.cleans[event.channel.id].join()
         del self.cleans[event.channel.id]
 
+        raise CommandSuccess('deleted {} messages'.format(size))
+
     @Plugin.command(
-	'bypass',
+	    'bypass',
         '<user:user> <role:str> [reason:str...]',
-	level=-1,
-	context={'mode': 'remove'},
-	group='role')
+	    level=-1,
+	    context={'mode': 'remove'},
+	    group='role')
     @Plugin.command(
         'add',
         '<user:user> <role:str> [reason:str...]',
diff --git a/rowboat/plugins/modlog/core.py b/rowboat/plugins/modlog/core.py
index b625b37..f6c7c56 100644
--- a/rowboat/plugins/modlog/core.py
+++ b/rowboat/plugins/modlog/core.py
@@ -306,7 +306,7 @@ class ModLogPlugin(Plugin):
             return event.msg.reply(':warning: modlog is already hushed')
 
         self.hushed[event.guild.id] = True
-        event.msg.reply(':white_check_mark: modlog has been hushed, do your dirty work in peace')
+        event.msg.reply(':white_check_mark: modlog hushed, do your dirty work in peace')
 
     @Plugin.command('unhush', group='modlog', level=CommandLevels.ADMIN)
     def command_unhush(self, event):
diff --git a/rowboat/plugins/spam.py b/rowboat/plugins/spam.py
index b0f28ec..78f9acb 100644
--- a/rowboat/plugins/spam.py
+++ b/rowboat/plugins/spam.py
@@ -19,10 +19,8 @@ from rowboat.types import SlottedModel, DictField, Field
 from rowboat.models.user import Infraction
 from rowboat.models.message import Message, EMOJI_RE
 
-
 UPPER_RE = re.compile('[A-Z]')
 
-
 PunishmentType = Enum(
     'NONE',
     'MUTE',
@@ -32,7 +30,6 @@ PunishmentType = Enum(
     'TEMPMUTE'
 )
 
-
 class CheckConfig(SlottedModel):
     count = Field(int)
     interval = Field(int)
@@ -72,7 +69,7 @@ class SubConfig(SlottedModel):
             raise Exception('Invalid value for `clean_duration` must be between 0 and 86400')
 
         if self.clean_count < 0 or self.clean_count > 1000:
-            raise Exception('Invaliud value for `clean_count` must be between 0 and 1000')
+            raise Exception('Invalid value for `clean_count` must be between 0 and 1000')
 
     def get_bucket(self, attr, guild_id):
         obj = getattr(self, attr)
@@ -134,7 +131,7 @@ class SpamPlugin(Plugin):
         if not last_violated > time.time() - 10:
             self.call(
                 'ModLogPlugin.log_action_ext',
-                Actions.SPAM_DEBUG,
+                Actions.SPAM,
                 violation.event.guild.id,
                 v=violation
             )
@@ -147,7 +144,7 @@ class SpamPlugin(Plugin):
                     self,
                     violation.event,
                     violation.member,
-                    'Spam Detected')
+                    'Spam Detected',)
             elif punishment == PunishmentType.TEMPMUTE:
                 Infraction.tempmute(
                     self,
diff --git a/rowboat/plugins/utilities.py b/rowboat/plugins/utilities.py
index 0840c8d..56f1451 100644
--- a/rowboat/plugins/utilities.py
+++ b/rowboat/plugins/utilities.py
@@ -219,7 +219,7 @@ class UtilitiesPlugin(Plugin):
                     (User.username == username) &
                     (User.discriminator == int(discrim))))
 
-        users = User.select().where(reduce(operator.or_, queries))
+        users = User.select().where(reduce(operator.or_, queries).limit(10))
         if len(users) == 0:
             return event.msg.reply(u'No users found for query `{}`'.format(S(query, escape_codeblocks=True)))
 
@@ -241,12 +241,14 @@ class UtilitiesPlugin(Plugin):
         content.append(u'**\u276F Server Information**')
 
         created_at = to_datetime(guild.id)
-        content.append(u'Created: {} ago ({})'.format(
-            humanize.naturaldelta(datetime.utcnow() - created_at),
+        content.append(u'Created: {} ({})'.format(
+            humanize.naturaltime(datetime.utcnow() - created_at),
             created_at.isoformat(),
         ))
-        content.append(u'Members: {}'.format(len(guild.members)))
-        content.append(u'Features: {}'.format(', '.join(guild.features) or 'none'))
+        
+        content.append(u'Members: {:,}'.format(len(guild.members)))
+        if guild.features:
+            content.append(u'Features: {}'.format(', '.join(guild.features)))
 
         content.append(u'\n**\u276F Counts**')
         text_count = sum(1 for c in guild.channels.values() if not c.is_voice)
-- 
2.24.1.windows.2

