From 981149f78aa61b0b87dee05837cc7bd8ee3e2fae Mon Sep 17 00:00:00 2001
From: DeJay <contact@dejaydev.com>
Date: Mon, 25 Nov 2019 00:17:25 -0600
Subject: [PATCH 14/24] commit to fix history

---
 docker-compose.yml           |  3 ++-
 rowboat/plugins/core.py      | 10 ++++++++--
 rowboat/plugins/utilities.py | 17 ++++++++++++++++-
 3 files changed, 26 insertions(+), 4 deletions(-)

diff --git a/docker-compose.yml b/docker-compose.yml
index 9948b9f..6aa1e81 100644
--- a/docker-compose.yml
+++ b/docker-compose.yml
@@ -1,4 +1,4 @@
-version: '2'
+version: '2.4'
 services:
   db:
     build: ./docker/database/
@@ -6,6 +6,7 @@ services:
       - ./.data:/var/lib/postgresql/data
     environment:
       - ENV=production
+    stop_grace_period: 1m
   redis:
     image: redis:3.2
     command: redis-server --appendonly yes
diff --git a/rowboat/plugins/core.py b/rowboat/plugins/core.py
index a0a5e24..c295818 100644
--- a/rowboat/plugins/core.py
+++ b/rowboat/plugins/core.py
@@ -328,10 +328,10 @@ class CorePlugin(Plugin):
             # If the guild is not awaiting setup, leave it now
             if not rdb.sismember(GUILDS_WAITING_SETUP_KEY, str(event.id)) and event.id != ROWBOAT_GUILD_ID:
                 self.log.warning(
-                    'Leaving guild %s (%s), not within setup list',
+                    'I am in guild %s (%s), and it\'s not within the  setup list',
                     event.id, event.name
                 )
-                event.guild.leave()
+                #event.guild.leave()
             return
 
         if not guild.enabled:
@@ -712,6 +712,12 @@ class CorePlugin(Plugin):
         rdb.srem(GUILDS_WAITING_SETUP_KEY, str(guild))
         event.msg.reply('Ok, I\'ve made sure guild %s is no longer in the whitelist' % guild)
 
+    @Plugin.command('leave', '<guild:snowflake>', group='guilds', level=-1)
+    def guild_leave(self, event, guild):
+        guild = self.state.guilds.get(guild)
+        guild.leave()
+        event.msg.reply('Ok, I\'ve left that guild.')
+
     @Plugin.command('disable', '<plugin:str>', group='plugins', level=-1)
     def plugin_disable(self, event, plugin):
         plugin = self.bot.plugins.get(plugin)
diff --git a/rowboat/plugins/utilities.py b/rowboat/plugins/utilities.py
index 2c7a325..0840c8d 100644
--- a/rowboat/plugins/utilities.py
+++ b/rowboat/plugins/utilities.py
@@ -108,12 +108,27 @@ class UtilitiesPlugin(Plugin):
             if not url.endswith('.gif'):
                 break
         else:
-            return event.msg.reply('404 Cat not found :(')
+            return event.msg.reply(r.status_code + ' Cat not found :(')
 
         r = requests.get(url)
         r.raise_for_status()
         event.msg.reply('', attachments=[('cat.jpg', r.content)])
 
+    @Plugin.command('dog', global_=True) #global_=True! what will he do?
+    def dog(self, event):
+        try:
+            r = requests.get('https://random.dog/woof',
+            params={'filter': 'mp4,webm,gif'}) #
+            r.raise_for_status()
+        except:
+            return event.msg.reply(r.status_code + ' Dog not found :(')
+
+        url = r.json()['file']
+
+        r = requests.get('https://random.dog/' + url)
+        r.raise_for_status()
+        event.msg.reply('', attachments=[(url, r.content)])
+
     @Plugin.command('emoji', '<emoji:str>', global_=True)
     def emoji(self, event, emoji):
         if not EMOJI_RE.match(emoji):
-- 
2.24.1.windows.2

